FROM oven/bun:1.1.38-alpine AS builder

WORKDIR /app

COPY package.json bun.lock* ./
RUN bun install --frozen-lockfile --no-dev

COPY src /app/src
COPY tsconfig.json ./
RUN bun install --frozen-lockfile

FROM oven/bun:1.1.38-alpine

ARG PORT
ARG DEV_HEADER
ARG DEV_JWT_DOMAIN
ARG NODE_ENV
ARG FRONTEND_URL
ARG MONGODB_URI
ARG REDIS_URL
ARG NEYNAR_API_KEY
ARG HUNDRED_MS_MANAGEMENT_TOKEN
ARG HUNDRED_MS_TEMPLATE_ID
ARG ADMIN_TOKEN

WORKDIR /app

COPY --from=builder /app /app

ENV PORT=${PORT}
ENV DEV_HEADER=${DEV_HEADER}
ENV DEV_JWT_DOMAIN=${DEV_JWT_DOMAIN}
ENV NODE_ENV=${NODE_ENV}
ENV FRONTEND_URL=${FRONTEND_URL}
ENV MONGODB_URI=${MONGODB_URI}
ENV REDIS_URL=${REDIS_URL}
ENV NEYNAR_API_KEY=${NEYNAR_API_KEY}
ENV HUNDRED_MS_MANAGEMENT_TOKEN=${HUNDRED_MS_MANAGEMENT_TOKEN}
ENV HUNDRED_MS_TEMPLATE_ID=${HUNDRED_MS_TEMPLATE_ID}
ENV ADMIN_TOKEN=${ADMIN_TOKEN}

ENTRYPOINT []

# Don't hardcode EXPOSE port - let Railway handle it
CMD ["bun", "run", "src/index.ts"]
